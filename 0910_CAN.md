# 0910_CAN

## CAN ( Controller Area Network )

- 우리가 일반적으로 사용하는 LAN (Local Area Network) 환경이 아닌 구조적으로 다른 Network 환경

- 1986년도 메르세데스 밴츠에서 로베르트 보쉬사에 의뢰를 함

  - 3개의 ECU가 통신할 수 있는 네트워크 구조를 만들어줘!

  - ECU ( Electronic Control Unit , 전자적 제어장치 )

    - 자동차에 들어있는 ECU를 간단하게 살펴보자 

      - ACU ( Airbag Control Unit )
      - BCM ( Body Control Module )

      - ECU ( Engine Control Unit )
      - TCU ( Transmission Control Unit ) : 변속기
      - ABS ( Anti-lock Breaking System ) : 브레이크와 관련된 보안 시스템
      - ECU 중 ID의 크기가 작은 순으로 중요도(우선 순위)가 높음
      - ECU 하나가 같은 종류의 센서들이 발생하는 데이터값을 같이 받음 (일대다 대응)
      - 네트워크 간에 통신을 하는 구조가 CAN

    - Genesis : 70개 ECU

      벤츠, BMW : 80개 ECU

      렉서스 : 100개 이상의 ECU

- 1986년 보쉬사가 개발하여 자동차 기술자 협회에 발표

- 1991년도에 CAN 2.0 발표

- 1992년 메르세데스 벤츠에서 CAN을 채택한 자동차 출시
- 1993년 ISO에 의해서 CAN이 표준화로 채택됨 

<br>

#### CAN은 어떤 방식으로 데이터 통신을 할까?

- ECU 간의 데이터 통신은 어떻게 하나?

  ![1568115773926](https://user-images.githubusercontent.com/50972986/64612462-dc2bcf00-d40e-11e9-9a93-5b305ed3e617.png)

  - 기본적으로 각 ECU를 선으로 연결하는 방식은 좋지 않음

    ECU마다 IO단자가 필요한데 IO단자는 일정 크기 이상 줄일 수 없어 소형화에 문제가 생김

  - 비용도 많이 발생하기 때문에 다른 방식으로 통신

    => **Serial (직렬) 통신**

<BR>

|      |                      Serial (직렬) 통신                      |                          병렬 통신                           |
| :--: | :----------------------------------------------------------: | :----------------------------------------------------------: |
| 장점 |  한 개의 선을 이용하므로<BR>소형화에 적합하고 비용이 저렴함  |       여러 개의 선을 이용해 통신하므로<BR>속도가 빠름        |
| 단점 | 한 개의 선으로 통신하기 때문에<BR>한 번의 통신이 끝날 때까지 기다려야 함<BR>속도가 느림 | 각각의 선마다 IO장치가 필요 => 소형화 X<BR>여러 개의 선이 필요하며<BR>멀어질수록선의 길이가 길어져서 비용이 증가함 |

- 우리가 사용하는 대표적인 직렬 통신 방식의 기기 : USB

  ​																					 컴퓨터의 COM 포트를 이용한 직렬 통신
  
  <BR>

##  Serial (직렬) 통신

![1568115567516](https://user-images.githubusercontent.com/50972986/64612479-e9e15480-d40e-11e9-998a-7f472bf531a3.png)

- 각각의 ECU를 서로 직접 연결시키는 것이 아니라 BUS 개념을 도입

- CAN은 CAN 버스에 대한 단일 입출력 interface만 가지고 있고 CAN 버스에 직접 접지하여 연결한 것이 특징, BUS에 떠다니는 정보 중 각자 필요한 정보를 가져다 씀. can bus cycle에 따라 idle 상태인지확인하고 사용하고 있지 않으면 ECU가 버스에 패킷을 전송 -> 필요한 곳에서 패킷을 가져다 씀

  두개의 ecu가 동시에메시지를 보내려고 하면 우선순위가 높은 ecu부터 처리됨 -> 병렬로 연결되어 있지만 하나의 한 msg만 처리 되기 때문에 직렬 통신이라고 함

- 자동차는 기본적으로 네트워크 환경이 굉장히 열악함

  - 온도, 충격, 진동이 많은 환경이라서 네트워크 통신시 오류 발생할 여지가 많음

- 자동차와 관련된 CAN 이외의 통신방식이 존재하지만 CAN이 대표적으로 많이 사용되고 언급되는 이유는 보안적으로나 견고한 통신 등 안정성이 있음

  - LAN( 이더넷 )은 보안에 취약 
  - CAN의 단점 : 1Mbps의 속도
    - 보안하기위해 다른 네트워크를 고려중

<br>

## CAN의 장점

- Multi master 통신을 함
  - 서버와 클라이언트가 존재하지 않음
  - CAN BUS가 Idle 상태이면 모든 ECU가 허락을 구하지 않고 스스로 데이터를 BUS에 보낼 수 있음

- 노이즈에 매우 강함

  - 차량 자체가 매우 열악한 환경인데

    CAN은 두 가닥의 꼬인 전선을 이용하여 전선의 전압차를 통해 데이터를 전송하는 방식

- 표준 프로토콜

  - 시장성이 확보될 수 있음

- 하드웨어적으로 오류 보정이 가능함

  - CRC를 하드웨어적으로 만들어서 전송

  - CRC를 이용하여 데이터 프레임의 오류가 있는지를 확인

    만약 오류가 있으면 응답을 보냄

    해당 응답을 확인해서 재전송하게 됨

<BR>

## 컴퓨터에 CAN 연결하기

- CAN 장비들을 [제어판] - [장치 관리자] - [기타 장치] - [CANpro Analyzer 속성] 이 보이면

  드라이버가 설치되지 않은 상태

- RealSYS_USB_Device_Driver(20170316).zip의 압축을 해제하고

  dp-chooser.exe을 실행 후 설치하면

  [제어판] - [장치 관리자] - [포트(COM & LPT)] - [USB Serial Port(com10)] 으로 인식 됨

  ![1568090123325](https://user-images.githubusercontent.com/50972986/64612512-f665ad00-d40e-11e9-9225-de777e48b22a.png)

- RT와 RT를 연결하여 접지시키고

  L은 L과 R은 R과 연결함

<BR>

- CanPro Analyzer 프로그램 실행

![1568090644689](https://user-images.githubusercontent.com/50972986/64612698-5eb48e80-d40f-11e9-8d09-027c0eb9d001.png)

<bR>

- Setting
  - [동작] - [CANPro 환경설정 쓰기] 
    - PC 통신 인터페이스 설정 : Serial 통신
    - 프로토콜 : CAN2.0B
      - CAN2.0A : 단방향
      - CAN2.0B : 양방향
    - CAN BPS는 1M가 최대 속도
    - Serial 통신 포트 : [제어판] - [장치 관리자] - [포트(COM & LPT)] 에 나타난 port 지정

![1568090595628](https://user-images.githubusercontent.com/50972986/64612762-8efc2d00-d40f-11e9-8a7b-b05ed18f6a05.png)